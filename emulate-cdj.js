#!/usr/bin/env node
var dgram = require("dgram");


var device = {
	channel: 4,
	//macaddr: [0x00,0x1f,0x16,0x2c,0xed,0xd1], // Laptop
	macaddr: [0xb8,0x27,0xeb,0x4a,0xe7,0xe1], // Raspi01
	master: false,
	sync: false,
	broadcastIP: '192.168.0.255',
	mixerIP: '192.168.0.90',
	//broadcastIP: '169.254.255.255',
	//mixerIP: '169.254.101.168',
	devices: {}
};

var sock0 = dgram.createSocket("udp4");
var sock1 = dgram.createSocket("udp4");
var sock2 = dgram.createSocket("udp4");

sock0.on("listening", function () {
	var address = sock0.address();
	console.log("server listening " +	address.address + ":" + address.port);
});
sock1.on("listening", function () {
	var address = sock1.address();
	console.log("server listening " +	address.address + ":" + address.port);
});
sock2.on("listening", function () {
	var address = sock2.address();
	console.log("server listening " +	address.address + ":" + address.port);
});

sock0.on("message", function (msg, rinfo) {
	//console.log("50000 server got: " + msg + " from " + rinfo.address + ":" + rinfo.port);
	var type = msg[0x0a];
	var typeStr = ('0'+type.toString(16)).substr(-2);
	var deviceName = msg.toString().substr(0x0b, 16).replace(/\x00/g, '');
	//console.log(rinfo.address + " " + deviceName + ' ' + typeStr);
	if(type==0x04){
		console.log('50000 Device '+rinfo.address+' is channel '+msg[0x23].toString(16));
		if(msg[0x23]==0x21){
			device.mixerIP = rinfo.address;
		}
		sendDeviceAck(rinfo.address);
	}else if(type==0x06){
		var chan = msg[0x24];
		console.log('50000 Device alive on network '+rinfo.address+' is channel '+msg[0x24].toString(16));
		device.devices[chan] = {
			chan: chan,
			alive: new Date,
			address: rinfo.address,
		};
		for(var n in device.devices){
			if(device.devices[n].alive.valueOf() > new Date().valueOf()+6000){
				delete device.devices[n];
				console.log('Lost '+n);
			}
		}
	}else if(type==0x08){
		console.log('50000 YouAreAJackass Someone else is using this channel');
	}else{
		console.log('50000 Unknown packet type '+typeStr);
	}
});
sock1.on("message", function (msg, rinfo) {
	//console.log("50001 server got: " + msg + " from " + rinfo.address + ":" + rinfo.port);
	var type = msg[0x0a];
	var typeStr = ('0'+type.toString(16)).substr(-2);
	if(type==0x2a){
		console.log('0x2a');
		// This packet is supposed to ask us to become master, I think?
		// Or slaved/synced
		var a = data[0x2b];
		if(a==0x10){
			slave = true;
		}else if(0x20){
			slave = false;
		}else if(a==0x01 || a==0x02){
			master = true;
			advertiseMaster();
		}else{
			console.log('50001 Unknown sync assignment???', a);
			slave = false;
			master = false;
		}
	}else if(type==0x26){
		console.log('50001 0x26 Someone else is master now');
		sendNewMasterAck(rinfo.address);
	}
});
sock2.on("message", function (msg, rinfo) {
	var type = msg[0x0a];
	var typeStr = ('0'+type.toString(16)).substr(-2);
	console.log("50002 " + rinfo.address + ":" + rinfo.port + ' ' + typeStr);
});

// 50000 0x0a
//0000   51 73 70 74 31 57 6d 4a 4f 4c 0a 00 43 44 4a 2d  Qspt1WmJOL..CDJ-
//0010   32 30 30 30 6e 65 78 75 73 00 00 00 00 00 00 00  2000nexus.......
//0020   01 02 00 25 01                                   ...%.
function send0x0a(){
	var b = Buffer([
		0x51,0x73,0x70,0x74,0x31,0x57,0x6d,0x4a,0x4f,0x4c,0x0a,0x00,0x43,0x44,0x4a,0x2d,
		0x32,0x30,0x30,0x30,0x6e,0x65,0x78,0x75,0x73,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x01,0x02,0x00,0x25,0x01,
	]);
	sock0.send(b, 0, b.length, 50000, device.broadcastIP, function(e){
		console.log(arguments);
	});
}

// 50000 0x00
//0000   51 73 70 74 31 57 6d 4a 4f 4c 00 00 43 44 4a 2d  Qspt1WmJOL..CDJ-
//0010   32 30 30 30 6e 65 78 75 73 00 00 00 00 00 00 00  2000nexus.......
//0020   01 02 00 2c 02 01 [MAC address....]              ...,..t^....
function send0x00(i){
	var m = device.macaddr;
	var b = Buffer([
		0x51, 0x73, 0x70, 0x74, 0x31, 0x57, 0x6d, 0x4a, 0x4f, 0x4c, 0x00, 0x00, 0x43, 0x44, 0x4a, 0x2d,
		0x32, 0x30, 0x30, 0x30, 0x6e, 0x65, 0x78, 0x75, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x02, 0x00, 0x2c, i,    0x01, m[0], m[1], m[2], m[3], m[4], m[5],
	]);
	sock0.send(b, 0, b.length, 50000, device.broadcastIP, function(e){
		console.log(arguments);
	});
}


// 50000 0x02
//0000   51 73 70 74 31 57 6d 4a 4f 4c 02 00 43 44 4a 2d
//0010   32 30 30 30 6e 65 78 75 73 00 00 00 00 00 00 00
//0020   01 02 00 32 c0 a8 00 5d 74 5e 1c 35 f3 9f 03 xx
//0030   01 02
function send0x02(i){
	var m = device.macaddr;
	var b = Buffer([
		0x51, 0x73, 0x70, 0x74, 0x31, 0x57, 0x6d, 0x4a, 0x4f, 0x4c, 0x02, 0x00, 0x43, 0x44, 0x4a, 0x2d,
		0x32, 0x30, 0x30, 0x30, 0x6e, 0x65, 0x78, 0x75, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x02, 0x00, 0x32, 0xc0, 0xa8, 0x00, 0x5d, m[0], m[1], m[2], m[3], m[4], m[5], 0x03, i,
		0x01, 0x02,
	]);
	sock0.send(b, 0, b.length, 50000, device.broadcastIP, function(e){
		console.log(arguments);
	});
}


// 50000 0x04
//0000   51 73 70 74 31 57 6d 4a 4f 4c 04 00 43 44 4a 2d  Qspt1WmJOL..CDJ-
//0010   32 30 30 30 6e 65 78 75 73 00 00 00 00 00 00 00  2000nexus.......
//0020   01 02 00 26 02 01                                ...&..

//0000   51 73 70 74 31 57 6d 4a 4f 4c 04 00 43 44 4a 2d
//0010   32 30 30 30 6e 65 78 75 73 00 00 00 00 00 00 00
//0020   01 02 00 26 03 01
function send0x04(){
	var chan = device.channel;
	var b = Buffer([
		0x51, 0x73, 0x70, 0x74, 0x31, 0x57, 0x6d, 0x4a, 0x4f, 0x4c, 0x04, 0x00, 0x43, 0x44, 0x4a, 0x2d,
		0x32, 0x30, 0x30, 0x30, 0x6e, 0x65, 0x78, 0x75, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x02, 0x00, 0x26, chan, 0x01
	]);
	sock0.send(b, 0, b.length, 50000, device.broadcastIP, function(e){
		console.log(arguments);
	});
}

// Starting with this packet, the DJM responds with 50000 0x05:
//0000   51 73 70 74 31 57 6d 4a 4f 4c 05 00 44 4a 4d 2d  Qspt1WmJOL..DJM-
//0010   32 30 30 30 6e 65 78 75 73 00 00 00 00 00 00 00  2000nexus.......
//0020   01 01 00 26 21 01                                ...&!.
// Packet identical to 0x04 except for bytes 0x0b, 0x21, 0x24, and device string


// The CDJ goes into regular discovery mode following this:
//0000   51 73 70 74 31 57 6d 4a 4f 4c 06 00 43 44 4a 2d  Qspt1WmJOL..CDJ-
//0010   32 30 30 30 6e 65 78 75 73 00 00 00 00 00 00 00  2000nexus.......
//0020   01 02 00 36 02 01 [mac addr    :ba] c0 a8 00 5c  ...6..t^.......\
//0030   01 00 00 00 01 00                                ......

function send0x06(){
	var chan = device.channel;
	var m = device.macaddr;
	var b = Buffer([
		0x51, 0x73, 0x70, 0x74, 0x31, 0x57, 0x6d, 0x4a, 0x4f, 0x4c, 0x06, 0x00, 0x43, 0x44, 0x4a, 0x2d,
		0x32, 0x30, 0x30, 0x30, 0x6e, 0x65, 0x78, 0x75, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x02, 0x00, 0x36, chan, 0x01, m[0], m[1], m[2], m[3], m[4], m[5], 0xc0, 0xa8, 0x00, 0x5c,
		0x01, 0x00, 0x00, 0x00, 0x01, 0x00
	]);
	sock0.send(b, 0, b.length, 50000, device.broadcastIP, function(e){
		console.log('0_x06 ', arguments);
	});
}

var beat = 0;
function send2x0a(target){
	++beat;
	var chan = device.channel;
	var b1 = (beat%256);
	var b2 = (beat%4)+1;
	var d0 = (beat>>8) & 0xff;
	var d1 = (beat>>0) & 0xff;
	var e = 0x7e | (device.sync?0x10:0);
	var b = Buffer([
		0x51, 0x73, 0x70, 0x74, 0x31, 0x57, 0x6d, 0x4a, 0x4f, 0x4c, 0x0a, 0x43, 0x44, 0x4a, 0x2d, 0x32,
		0x30, 0x30, 0x30, 0x6e, 0x65, 0x78, 0x75, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
		0x03, chan, 0x00, 0xb0, chan, 0x00, 0x00, 0x00, 0x03, 0x01, 0x05, 0x00, 0x00, 0x00, 0x00, 0x01,
		0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x08, 0x00, 0x2e, 0x93, 0x03, 0x00,
		0xf4, 0x72, 0x00, 0x00, 0xb3, 0x24, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x22, 0x04, 0x04, 0x00, 0x00, 0x00, 0x04,
		0x00, 0x00, 0x00, 0x04, 0x00, 0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x06, 0x31, 0x2e, 0x32, 0x32,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0xa4, 0x0d, e,    0x00, 0x10, 0x00, 0x00,
		0x00, 0x00, 0x32, 0x04, 0x7f, 0xff, 0xff, 0xff, 0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x02, 0xff,
		0xff, 0xff, d0,   d1,   0x01, b1,   b2,   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x0f, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00
	]);
	sock2.send(b, 0, b.length, 50002, target, function(e){
		console.log('2_x0a', arguments);
	});
}

function advertiseNewMaster(){
	for(var n in device.devices){
		send1x26(device.channel);
	}
	// TODO if no 1_x27 packet is received from each device, re-send
}

function send1x26(chan){
	// 50001 0x26
	var c = device.channel;
	var b = Buffer([
		0x51, 0x73, 0x70, 0x74, 0x31, 0x57, 0x6d, 0x4a, 0x4f, 0x4c, 0x26, 0x72, 0x65, 0x6b, 0x6f, 0x72,
		0x64, 0x62, 0x6f, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
		0x01, 0x11, 0x00, 0x04, 0x00, 0x00, 0x00, chan,
	]);
	sock2.send(b, 0, b.length, 50001, ip, function(e){
		console.log('1_x26', arguments);
	});
}


function sendNewMasterAck(ip){
	// 50001 0x27
	var c = device.channel;
	var b = Buffer([
		0x51, 0x73, 0x70, 0x74, 0x31, 0x57, 0x6d, 0x4a, 0x4f, 0x4c, 0x27, 0x43, 0x44, 0x4a, 0x2d, 0x32,
		0x30, 0x30, 0x30, 0x6e, 0x65, 0x78, 0x75, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
		0x00, c,    0x00, 0x08, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01,
	]);
	sock2.send(b, 0, b.length, 50001, ip, function(e){
		console.log('sendNewMasterAck', arguments);
	});
}

function sendDeviceAck(ip){
	// 50000 0x05
	var c = device.channel;
	var b = Buffer([
		0x51, 0x73, 0x70, 0x74, 0x31, 0x57, 0x6d, 0x4a, 0x4f, 0x4c, 0x05, 0x00, 0x44, 0x4a, 0x4d, 0x2d,
		0x32, 0x30, 0x30, 0x30, 0x6e, 0x65, 0x78, 0x75, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x02, 0x00, 0x26, c,    0x01,
	]);
	sock0.send(b, 0, b.length, 50000, ip, function(e){
		console.log('sendDeviceAck', arguments);
	});
}

sock0.bind(50000, onBound0);
sock1.bind(50001, onBound1);
sock2.bind(50002, onBound2);

function onBound0(){
	var wait = 400;
	sock0.setBroadcast(true);
	// Start-up sequence for powered from a switch:
	// 0_0a, 0_00, 0_02, 0_04
	setTimeout(send0x0a, 1*wait);
	setTimeout(send0x0a, 2*wait);
	setTimeout(send0x0a, 3*wait);
	setTimeout(send0x00.bind(null, 1), 4*wait);
	setTimeout(send0x00.bind(null, 2), 5*wait);
	setTimeout(send0x00.bind(null, 3), 6*wait);
	setTimeout(send0x02.bind(null, 1), 7*wait);
	setTimeout(send0x02.bind(null, 2), 8*wait);
	setTimeout(send0x02.bind(null, 3), 9*wait);
	setTimeout(send0x04, 10*wait);
	setTimeout(function(){
		setInterval(send0x06, 2000);
	}, 11*wait);
}

function onBound1(){}

function onBound2(){
	setTimeout(function(){
		setInterval(function(){
			for(var n in device.devices){
				send2x0a(device.devices[n].address);
			}
		}, parseInt(60000/138));
	}, 10000);
}
